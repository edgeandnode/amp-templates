# Fastify Backend Development Tasks

# Show available tasks
default:
    @just --list

# Start all infrastructure services
start:
    docker-compose up -d

# Stop all services
stop:
    docker-compose down

# Reset all data (removes volumes)
reset:
    docker-compose down -v

# View service logs
logs service="":
    #!/usr/bin/env sh
    if [ "{{ service }}" = "" ]; then
        docker-compose logs -f
    else
        docker-compose logs -f {{ service }}
    fi

# Check service status
status:
    docker-compose ps

# Deploy dataset to Amp
deploy-dataset:
    pnpm amp register

# Deploy smart contracts
deploy-contracts:
    forge script script/Deploy.s.sol:Deploy --rpc-url http://localhost:8545 --broadcast --unlocked

# Generate blockchain activity
generate-activity:
    cd contracts && forge script script/GenerateActivity.s.sol:GenerateActivity --rpc-url http://localhost:8545 --broadcast --unlocked --sender 0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266

# Complete setup: start services, deploy contracts, generate activity, start backend
setup:
    @echo "ðŸš€ Starting complete AMP setup..."
    @just start
    @echo "Waiting for services to start..."
    @sleep 30
    @echo "Deploying contracts and generating blockchain activity..."
    @just generate-activity
    @echo "Starting Amp dev mode to register datasets..."
    @just start-amp-dev
    @echo "Starting backend server..."
    @just start-backend
    @echo "Setup complete! Testing API..."
    @sleep 10
    @curl -s "http://localhost:3001/health" | jq
    @echo "\nâœ… Ready! Available endpoints:"
    @echo "  â€¢ Health: curl http://localhost:3001/health"
    @echo "  â€¢ Blocks: curl http://localhost:3001/api/blocks?limit=3"
    @echo "  â€¢ Transfers: curl http://localhost:3001/api/transfers?limit=3"
    @echo "  â€¢ Documentation: curl http://localhost:3001/"

# Start Amp dev mode (for dataset registration and hot reloading)
start-amp-dev:
    pnpm amp dev &

# Start backend server locally
start-backend:
    docker-compose stop fastify-backend || true
    AMP_FLIGHT_URL=http://localhost:3002 pnpm dev &

# Generate blockchain activity (includes contract deployment)
seed-transfers:
    @just generate-activity

# Build backend
build:
    pnpm build

# Start backend locally (for development)
dev:
    AMP_FLIGHT_URL=http://localhost:3002 pnpm dev

# Test the API endpoints
test-api:
    @echo "ðŸ§ª Testing API endpoints..."
    @echo "Health check:"
    @curl -s "http://localhost:3001/health" | jq
    @echo "\nBlocks:"
    @curl -s "http://localhost:3001/api/blocks?limit=3" | jq
    @echo "\nTransfers:"
    @curl -s "http://localhost:3001/api/transfers?limit=3" | jq

# List registered datasets
datasets:
    pnpm amp datasets list

# Clean up everything
clean:
    docker-compose down -v
    docker system prune -f